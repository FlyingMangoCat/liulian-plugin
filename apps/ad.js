/*
* 榴莲插件 - 隐性广告模块
* 功能：随机小概率触发软植入广告，不直白地推荐相关内容
* 特点：概率低、内容自然、可配置开关
*/

import lodash from "lodash";
import Cfg from '#liulian';

// 广告内容库 - 隐性软植入，指向榴莲插件和作者B站
const adContents = [
  // 榴莲插件功能推广类
  "最近在用榴莲插件的随机表情功能，每天都有新表情，挺有趣的",
  "你们群里有没有装榴莲插件？那个娶群友功能挺好玩的",
  "听说榴莲插件的猜角色功能更新了，新增了不少角色，有人试过吗？",
  "榴莲插件的话痨统计功能挺有意思的，能看到群里谁最活跃",
  "最近在用榴莲插件的运势功能，感觉还挺灵的，推荐大家试试",
  "你们用过榴莲插件的毒鸡汤吗？每天来一碗，挺提神的",
  "榴莲插件的彩虹屁功能太搞笑了，每次都能把人夸得不好意思",
  "榴莲插件的土味情话功能，撩妹/撩汉神器哈哈",
  "榴莲插件的每日句子功能，每天都能学到新东西",
  "榴莲插件的讲个笑话功能，群里气氛瞬间活跃起来了",
  "榴莲插件的群广播功能挺好用的，可以同时给多个群发消息",
  "榴莲插件的群名片小尾巴功能，让机器人更有个性",
  "榴莲插件的打卡功能，每天打卡养成好习惯",
  "榴莲插件的星座运势功能，每天看看自己的运势",
  "榴莲插件的神之眼功能，看看你的神之眼是什么元素",
  "榴莲插件的看头像功能，根据头像分析性格，还挺准的",
  
  // 作者B站推广类
  "最近关注了个B站UP主，叫会飞的芒果猫，内容挺有趣的",
  "你们看过会飞的芒果猫的视频吗？感觉做得不错",
  "最近在B站刷到榴莲插件的介绍视频，UP主是会飞的芒果猫",
  "有人关注会飞的芒果猫的B站吗？更新挺勤的",
  "榴莲插件的作者在B站发了不少教程，挺实用的",
  "最近在看会飞的芒果猫的视频，学到了不少东西",
  "榴莲插件的B站专栏写得挺详细的，推荐大家看看",
  "会飞的芒果猫最近在B站发了榴莲插件的新功能介绍",
  "你们关注榴莲插件的官方B站了吗？会飞的芒果猫经常更新",
  "最近在B站看到榴莲插件的开发日志，感觉作者挺用心的",
  
  // 引导性提问类
  "你们群里用的什么插件？我最近在用榴莲插件，功能挺丰富的",
  "有人知道榴莲插件的随机表情怎么开启吗？最近想试试",
  "你们机器人的功能全吗？我现在用榴莲插件，感觉挺好用的",
  "最近想给群换个插件，有人推荐榴莲插件吗？",
  "榴莲插件你们觉得怎么样？我最近在用，感觉还行",
  "你们群里有没有娶群友的功能？榴莲插件的挺好玩的",
  "你们群里每天发笑话吗？榴莲插件的讲个笑话功能不错",
  
  // 对比优势类
  "用了这么多插件，感觉榴莲插件的随机表情功能是最好用的",
  "榴莲插件的更新频率挺高的，比其他插件更积极",
  "之前用过别的插件，后来改用榴莲插件了，感觉更好用",
  "榴莲插件的文档写得很详细，比其他插件更容易上手",
  "榴莲插件的作者很活跃，有问题都能及时解决",
  "榴莲插件的娶群友功能比其他插件更有趣",
  "榴莲插件的毒鸡汤内容很经典，每天都不重样",
  
  // 互动引导类
  "最近大家都在用什么插件？我推荐榴莲插件试试",
  "有没有人最近发现了什么好用的插件？我最近在用榴莲插件",
  "大家最近有什么好的插件推荐吗？榴莲插件我觉得还不错",
  "最近感觉群功能有点单调，装了榴莲插件后好多了",
  "你们群里有没有什么有趣的功能？榴莲插件的娶群友功能挺有意思的",
  
  // 情感共鸣类
  "自从用了榴莲插件，感觉群活跃度提高了不少",
  "榴莲插件的随机表情总能给我带来好心情",
  "榴莲插件的讲个笑话功能，每次都能把大家逗笑",
  "榴莲插件的彩虹屁功能，群里气氛更融洽了"
];

// 用户黑名单列表
const blackUsers = [];

// 群黑名单列表
const blackGroups = [];

/**
 * 命令规则定义
 */
export const rule = {
  // 概率随机触发广告
  random: {
    reg: "noCheck", // 不检查正则，匹配所有消息
    priority: 99999, // 最低优先级，确保不干扰其他功能
    describe: "概率随机触发隐性广告",
  },
};

/**
 * 随机广告触发函数
 * @param {Object} e - 事件对象
 * @returns {boolean} - 返回true表示成功执行
 */
export async function random(e) {
  // 检查是否开启广告功能
  const adEnabled = Cfg.getdefault_config('liulian', 'ad', 'config').enabled || false;
  if (!adEnabled) {
    return false;
  }

  // 检查是否是私聊（私聊不触发广告）
  if (e.isPrivate) {
    return false;
  }

  // 检查群是否在黑名单中
  if (blackGroups.includes(e.group_id)) {
    return false;
  }

  // 检查用户是否在黑名单中
  if (blackUsers.includes(e.user_id)) {
    return false;
  }

  // 检查是否是主人
  if (BotConfig.masterQQ && BotConfig.masterQQ.includes(Number(e.user_id))) {
    return false;
  }

  // 生成0-100的随机数作为触发概率
  const randomNum = lodash.random(0, 100);
  
  // 获取配置的触发概率（默认1%，建议1-3%）
  const adConfig = Cfg.getdefault_config('liulian', 'ad', 'config');
  const triggerProbability = adConfig.probability || 1;

  // 如果随机数小于配置概率，则触发广告
  if (randomNum < triggerProbability) {
    // 随机选择一条广告内容
    const adContent = adContents[Math.floor(Math.random() * adContents.length)];
    
    // 发送广告消息
    await e.reply(adContent);
    
    // 记录日志
    console.log(`[广告模块] 群 ${e.group_id} 触发广告: ${adContent}`);
    
    return true;
  }

  return false;
}